<!doctype html>
<html lang="en" data-theme="dark">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Chat</title>
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
            integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        />
        <style>
            :root {
                --primary: #fec20f;
            }
        </style>
    </head>
    <body>
        <main class="container">
            <nav>
                <ul>
                    <li>
                        <a href="/"
                            ><img
                                src="/assets/circlesbs.png"
                                style="width: 200px"
                        /></a>
                    </li>
                </ul>
                <ul id="actions">
                    <h6
                        id="cw"
                        style="float: right; transform: translateY(10px)"
                    ></h6>

                    <li><a href="/chat">Back</a></li>
                </ul>
            </nav>
            <article
                id="atc"
                style="margin-top: 30px; height: 70vh; overflow: auto"
            >
                <div id="chatMsgContainer">
                    <div
                        id="chatTemplate"
                        style="
                            background-color: var(--pico-background-color);
                            padding-top: 40px;
                            padding-bottom: 10px;
                            padding-left: 30px;
                            border-radius: 20px;
                            display: none;
                            margin-bottom: 10px;
                        "
                    >
                        <h5 class="uname" style="line-height: 0">Username</h5>
                        <p class="umsg" style="color: gray">User Message</p>
                    </div>
                </div>
            </article>
            <input
                type="text"
                id="chatMsgInput"
                placeholder="Type a message..."
                style="width: 100%"
            />
        </main>
        <script>
            // get id from query
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get("id");
            var username = "";
            var myuid = "";

            const scrollToBottomWithSmoothScroll = () => {
                var id = "atc";
                const element = document.getElementById(id);
                element.scrollTop = element.scrollHeight;
            };

            const chatMsgContainer =
                document.getElementById("chatMsgContainer");
            const chatTemplate = document.getElementById("chatTemplate");

            var hasLoaded = false;

            function rl() {
                fetch("/chats/" + id)
                    .then((res) => res.json())
                    .then((data) => {
                        data = data.chat;

                        chatMsgContainer.innerHTML = "";

                        var it = 0;

                        const p = document.createElement("p");
                        p.id = "noMsg";
                        p.textContent = data.prompt;
                        chatMsgContainer.appendChild(p);

                        data.messages.forEach((msg) => {
                            it += 1;

                            const clone = chatTemplate.cloneNode(true);
                            const uname = clone.querySelector(".uname");
                            const umsg = clone.querySelector(".umsg");

                            var msgUser = "";

                            if (msg.uid === myuid) {
                                msgUser = username;
                            } else {
                                msgUser = data.otherUserNames[0];
                            }

                            clone.style.display = "block";
                            uname.textContent = msgUser;
                            umsg.textContent = msg.message;

                            document.getElementById("cw").textContent =
                                "Chatting with " +
                                data.otherUserNames[0] +
                                "  |";

                            chatMsgContainer.appendChild(clone);
                        });

                        /*
                        if (it === 0) {
                            const p = document.createElement("p");
                            p.id = "noMsg";
                            p.textContent = data.prompt;
                            chatMsgContainer.appendChild(p);
                        }
                        */

                        if (!hasLoaded) {
                            scrollToBottomWithSmoothScroll();
                            hasLoaded = true;
                        }
                    });
            }

            fetch("/myuser")
                .then((res) => res.json())
                .then((data) => {
                    username = data.user.name;
                    myuid = data.user.uid;

                    console.log(data);

                    setInterval(() => {
                        rl();
                    }, 1000);
                });

            const chatMsgInput = document.getElementById("chatMsgInput");
            // detect enter key
            chatMsgInput.addEventListener("keyup", (e) => {
                if (e.key === "Enter") {
                    const clone = chatTemplate.cloneNode(true);
                    const uname = clone.querySelector(".uname");
                    const umsg = clone.querySelector(".umsg");

                    clone.style.display = "block";
                    uname.textContent = username;
                    umsg.textContent = chatMsgInput.value;

                    chatMsgContainer.appendChild(clone);
                    var input = chatMsgInput.value;
                    chatMsgInput.value = "";

                    scrollToBottomWithSmoothScroll();

                    // POST /chats/uid
                    fetch("/chats/" + id + "/messages", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            id: myuid,
                            message: input,
                        }),
                    }).then(() => {
                        rl();
                    });
                }
            });
        </script>
    </body>
</html>
